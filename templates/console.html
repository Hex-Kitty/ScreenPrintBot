<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QuickQuote Console — {{ cfg.brand_name }}</title>

  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  {% set theme = cfg.console.theme if cfg.console and cfg.console.theme else {} %}
  {% set is_dark = theme.mode == 'dark' if theme.mode else false %}
  
  <style>
    :root{
      /* Button accent from config */
      --btn: {{ (cfg.buttons.bg if cfg.buttons and cfg.buttons.bg else cfg.colors.accent if cfg.colors else '#06B6D4') }};
      --btn-hover: {{ (cfg.buttons.hover if cfg.buttons and cfg.buttons.hover else '#0891B2') }};
      --btn-text: {{ (cfg.buttons.text if cfg.buttons and cfg.buttons.text else '#0F172A') }};
      
      /* Theme colors */
      --bg: {{ theme.bg if theme.bg else ('#0F172A' if is_dark else '#f6f7f8') }};
      --bg-secondary: {{ theme.bg_secondary if theme.bg_secondary else ('#1E293B' if is_dark else '#ffffff') }};
      --card-bg: {{ theme.card_bg if theme.card_bg else ('#1E293B' if is_dark else '#ffffff') }};
      --text: {{ theme.text if theme.text else ('#FFFFFF' if is_dark else '#111827') }};
      --text-muted: {{ theme.text_muted if theme.text_muted else ('#94A3B8' if is_dark else '#6b7280') }};
      --border: {{ theme.border if theme.border else ('#334155' if is_dark else '#e5e7eb') }};
      --border-light: {{ theme.border_light if theme.border_light else ('#475569' if is_dark else '#f3f4f6') }};
      
      /* Chips */
      --chip-bg: {{ theme.chip_bg if theme.chip_bg else ('#334155' if is_dark else '#f8f9fa') }};
      --chip-border: {{ theme.chip_border if theme.chip_border else ('#475569' if is_dark else '#ddd') }};
      --chip-text: {{ theme.chip_text if theme.chip_text else ('#E2E8F0' if is_dark else '#111') }};
      --chip-hover: {{ theme.chip_hover if theme.chip_hover else ('#475569' if is_dark else '#eee') }};
      --chip-active-bg: {{ theme.chip_active_bg if theme.chip_active_bg else (cfg.buttons.bg if cfg.buttons and cfg.buttons.bg else '#06B6D4') }};
      --chip-active-text: {{ theme.chip_active_text if theme.chip_active_text else '#0F172A' }};
      
      /* Cards */
      --card-border: {{ theme.card_border if theme.card_border else ('#334155' if is_dark else '#eee') }};
      
      /* Badge */
      --badge-bg: {{ theme.badge_bg if theme.badge_bg else ('#334155' if is_dark else '#e6e7e8') }};
      --badge-text: {{ theme.badge_text if theme.badge_text else ('#94A3B8' if is_dark else '#4b5563') }};
      --badge-border: {{ theme.badge_border if theme.badge_border else ('#475569' if is_dark else '#6b7280') }};
      
      /* Inputs */
      --input-bg: {{ theme.input_bg if theme.input_bg else ('#1E293B' if is_dark else '#ffffff') }};
      --input-border: {{ theme.input_border if theme.input_border else ('#475569' if is_dark else '#ddd') }};
      --input-text: {{ theme.input_text if theme.input_text else ('#E2E8F0' if is_dark else '#111') }};
      --input-placeholder: {{ theme.input_placeholder if theme.input_placeholder else ('#64748B' if is_dark else '#999') }};
      
      /* Price panel */
      --price-bg: {{ theme.price_bg if theme.price_bg else ('#0F172A' if is_dark else '#f9f9f9') }};
      --price-border: {{ theme.price_border if theme.price_border else ('#334155' if is_dark else '#eee') }};
      
      /* Breakdown headers */
      --breakdown-header-bg: {{ theme.breakdown_header_bg if theme.breakdown_header_bg else ('#334155' if is_dark else '#f2f2f2') }};
    }

    * { box-sizing: border-box; }
    body{ 
      margin:0; 
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      color: var(--text);
      background: var(--bg);
    }

    /* Layout grid */
    .qqc{
      display:grid;
      grid-template-columns: 340px 1fr;
      min-height:100vh;
      position:relative;
    }
    aside{
      grid-column: 1 / 2;
      padding:16px;
      border-right:1px solid var(--border);
      background: var(--bg-secondary);
      position:sticky;
      top:0;
      z-index:1;
    }
    main{
      grid-column: 2 / 3;
      padding:20px;
      position:relative;
      z-index:2;
      background: var(--bg);
    }

    h1{ margin:0 0 4px; font-size:26px; line-height:1.1; display:flex; align-items:center; gap:8px; color: var(--text); }
    .tag{ font-size:12px; color: var(--text-muted); margin-bottom:10px; }

    /* Brand bar */
    .brandbar{ display:flex; align-items:center; gap:10px; margin:0; }
    .brandbar img{ height:54px; max-width:200px; object-fit:contain; display:block; }
    .tenant-badge{
      align-self:flex-start;
      font-size:11px; line-height:1; padding:4px 8px;
      border-radius:999px;
      background: var(--badge-bg); 
      color: var(--badge-text); 
      border:1px solid var(--badge-border);
      letter-spacing:.2px;
    }
    .brand-divider{ border-bottom:1px solid var(--border); margin:0 0 12px; }
    @media (max-width: 420px){ .brandbar img{ height:32px; } }

    /* Beta badge */
    .beta-badge {
      display:inline-block;
      font-family: "Courier New", Courier, monospace;
      font-size:12px;
      font-weight:500;
      padding:2px 8px;
      border-radius:4px;
      background: var(--badge-bg);
      color: var(--badge-text);
      border:1px solid var(--badge-border);
      white-space:nowrap;
    }

    /* Price panel */
    .price{ 
      margin-top:10px; 
      padding:12px; 
      border:1px solid var(--price-border); 
      border-radius:10px; 
      background: var(--price-bg); 
    }
    #live-total{ font-size:28px; font-weight:700; color: var(--text); }

    .row{ margin:16px 0; }
    .row > strong{ display:block; margin-bottom:8px; color: var(--text); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }

    button.chip{
      padding:10px 14px; 
      border:1px solid var(--chip-border); 
      background: var(--chip-bg); 
      color: var(--chip-text);
      border-radius:999px;
      cursor:pointer; 
      transition: all .15s ease; 
      user-select:none; 
      pointer-events:auto;
      font-size: 14px;
    }
    button.chip:hover{ background: var(--chip-hover); }
    button.chip.active{
      color: var(--chip-active-text); 
      background: var(--chip-active-bg); 
      border-color: var(--chip-active-bg);
      box-shadow:0 0 0 2px color-mix(in oklab, var(--chip-active-bg) 30%, transparent);
    }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(230px,1fr)); gap:12px; }
    .card{ 
      border:1px solid var(--card-border); 
      border-radius:12px; 
      padding:12px; 
      background: var(--card-bg); 
    }
    .card > .card-title { font-weight:700; margin-bottom:8px; color: var(--text); }

    .actions{ display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; align-items:center; }
    .btn{ 
      padding:10px 16px; 
      border-radius:10px; 
      border:1px solid var(--border); 
      background: var(--card-bg); 
      color: var(--text);
      cursor:pointer; 
      transition: background .15s ease;
      font-weight: 500;
    }
    .btn:hover{ background: var(--chip-hover); }
    .btn.primary{ 
      background: var(--btn); 
      color: var(--btn-text); 
      border-color: var(--btn); 
    }
    .btn.primary:hover{
      background: var(--btn-hover);
      border-color: var(--btn-hover);
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .note{ font-size:.9rem; color: var(--text-muted); }
    .mini{ font-size:12px; color: var(--text-muted); }
    .breakdown h3{
      margin:10px 0 6px; font-size:14px; font-weight:600;
      background: var(--breakdown-header-bg); 
      padding:4px 6px; 
      border-radius:6px;
      color: var(--text);
    }
    .breakdown .line{ display:flex; justify-content:space-between; font-size:13px; padding:4px 0; color: var(--text); }
    .muted{ color: var(--text-muted); }
    .sep{ height:1px; background: var(--border); margin:10px 0; }

    .icon-btn{ 
      border:0; 
      background:transparent; 
      cursor:help; 
      width:28px; 
      height:28px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      font-size:16px; 
      line-height:1; 
      border-radius:6px;
      color: var(--text-muted);
    }
    .icon-btn:hover{ background: var(--chip-hover); }

    #screens-counter{ color: var(--text); }
    #screens-counter.active{ border:1px solid var(--text); padding:2px 6px; border-radius:6px; }

    .color-columns{ display:grid; gap:8px; }
    .color-columns.one{ grid-template-columns: 1fr; grid-auto-flow: row; }
    .color-columns.two{ grid-template-columns: repeat(2, minmax(0,1fr)); grid-auto-flow: column; grid-template-rows: repeat(5, auto); }
    .color-columns .chip{ width:100%; text-align:center; }

    /* Manual/Custom garment inputs */
    .inline-input{ display:flex; gap:8px; align-items:center; max-width:520px; margin-top:6px; flex-wrap:wrap; }
    .inline-input .money{ 
      display:flex; 
      align-items:center; 
      border:1px solid var(--input-border); 
      background: var(--input-bg); 
      border-radius:10px; 
      padding:8px 10px; 
      width:160px; 
      line-height:1.2; 
    }
    .inline-input .money span{ color: var(--text-muted); margin-right:4px; }
    .inline-input .money input{ 
      border:0; 
      outline:0; 
      width:100%; 
      font:inherit; 
      padding:0; 
      min-width:0; 
      line-height:1.2;
      background: transparent;
      color: var(--input-text);
    }
    .inline-input .money input::placeholder { color: var(--input-placeholder); }
    
    .inline-input .text{ 
      display:flex; 
      align-items:center; 
      border:1px solid var(--input-border); 
      background: var(--input-bg); 
      border-radius:10px; 
      padding:8px 10px; 
      min-width:240px; 
      flex:1 1 260px; 
      line-height:1.2; 
      overflow:hidden; 
    }
    .inline-input .text input{ 
      border:0; 
      outline:0; 
      width:100%; 
      font:inherit; 
      padding:0; 
      min-width:0; 
      line-height:1.2; 
      text-overflow: ellipsis; 
      white-space: nowrap; 
      overflow:hidden;
      background: transparent;
      color: var(--input-text);
    }
    .inline-input .text input::placeholder { color: var(--input-placeholder); }
    
    .badge{ 
      display:inline-block; 
      margin-top:6px; 
      padding:.25rem .5rem; 
      border-radius:9999px; 
      border:1px solid var(--border); 
      color: var(--text-muted); 
      font-size:12px;
      background: var(--badge-bg);
    }
    .badge.active{ 
      border-color: var(--chip-active-bg); 
      color: var(--chip-active-bg); 
      background: color-mix(in oklab, var(--chip-active-bg) 15%, transparent); 
    }

    /* Checkbox styling for dark mode */
    .checkbox-wrap {
      display: flex; 
      align-items: center; 
      gap: 8px; 
      background: var(--chip-bg); 
      padding: 8px 12px; 
      border-radius: 8px; 
      margin: 8px 0;
      border: 1px solid var(--border);
    }
    .checkbox-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--chip-active-bg);
    }
    .checkbox-wrap label {
      font-weight: 500;
      cursor: pointer;
      color: var(--text);
    }

    /* Email input */
    input[type="email"] {
      padding: 8px 12px;
      min-width: 260px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--input-text);
      border-radius: 8px;
      font-size: 14px;
    }
    input[type="email"]::placeholder {
      color: var(--input-placeholder);
    }

    /* Errors */
    .error{ color:#ef4444; }

    /* Rush line styling */
    .breakdown .line.rush span,
    .breakdown .line.rush strong{
      color:#ef4444;
      font-weight:600;
    }

    /* Dialog/Modal styling */
    dialog {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.6);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ---------- Responsive ---------- */
    @media (max-width: 1024px) {
      .qqc{ grid-template-columns: 1fr; gap:12px; min-height: 100dvh; }
      aside{ 
        grid-column: 1 / 2; 
        position: sticky; 
        top:0; 
        z-index:1; 
        background: var(--bg-secondary); 
        border-bottom:1px solid var(--border); 
        border-right: none;
        padding:12px 16px; 
      }
      main{ grid-column: 1 / 2; padding:12px 16px 24px; z-index:2; }
      .brandbar{ gap:8px; }
      .brandbar img{ height:28px; max-width:120px; }
      .tenant-badge{ font-size:10px; padding:3px 6px; border-radius:8px; }
      .chips{ display:flex; gap:10px; overflow-x:auto; padding-bottom:6px; -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity; }
      .chips .chip{ flex:0 0 auto; scroll-snap-align:start; }
      #garment-chips .chip{ white-space:nowrap; }
      #color-grid .card{ padding:10px; }
      .color-columns{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }
      .color-columns .chip{ width:100%; }
      .actions{ flex-wrap:wrap; gap:8px; }
      .actions .btn, .actions input[type="email"]{ width:100%; }
    }
    @media (max-width: 640px) {
      h1{ font-size:24px; }
      #live-total{ font-size:24px; }
      .note,.mini{ font-size:12px; }
      .brandbar img{ height:26px; max-width:110px; }
      .tenant-badge{ font-size:9.5px; padding:2px 6px; }
      .chips{ gap:8px; }
      .chips .chip{ padding:9px 12px; font-size:14px; }
      .color-columns{ grid-template-columns:1fr; }
      .btn{ padding:12px 14px; font-weight:600; }
    }
    @media (max-width: 380px){ .chips .chip{ padding:8px 10px; font-size:13px; } .brandbar img{ height:24px; } }
  </style>
</head>
<body>
  <div class="qqc">
    <aside>
      <div class="brandbar">
        <img src="{{ cfg.logo_path or '/static/logos/default.png' }}" alt="{{ cfg.brand_name }}" width="200" height="54">
        <span class="tenant-badge">{{ tenant|upper }}</span>
      </div>
      <div class="brand-divider"></div>

      <h1>
        QuickQuote Console
        <span class="beta-badge">v1.1.0</span>
      </h1>
      <div class="tag">Part of the ScreenPrintBot family</div>

      <div class="price">
        <div id="live-total">$0.00</div>
        <div class="mini muted" id="live-garment">Select a garment to begin</div>
        <div class="sep"></div>
        <div id="live-breakdown" class="breakdown note">Waiting for inputs…</div>
      </div>
    </aside>

    <main>
      <div class="row">
        <strong>Quantity</strong>
        <div class="chips" id="qty-chips">
          {% set qty_presets = (cfg.console.qty_presets if cfg.console and cfg.console.qty_presets else [12,24,36,48,72,100,150,250,500]) %}
          {% for q in qty_presets %}
            <button class="chip" data-qty="{{ q }}">{{ q }}</button>
          {% endfor %}
          <button class="chip" id="qty-other">Other…</button>
        </div>
      </div>

      <div class="row">
        <strong>Garment</strong>
        
        <div class="checkbox-wrap">
          <input type="checkbox" id="customer-supplied-toggle">
          <label for="customer-supplied-toggle">Customer is supplying garments (quote printing only)</label>
        </div>
        <div id="garment-section-wrapper"> <div class="chips" id="garment-chips">
            {% set garments = (cfg.console.garments if cfg.console and cfg.console.garments else []) %}
            {% for g in garments %}
              <button class="chip" data-gkey="{{ g.key }}">{{ g.label }} — ${{ '%.2f'|format(g.cost) }}</button>
            {% endfor %}
            <button class="chip" id="custom-garment-chip" title="Enter a name and cost for a garment not listed">Custom Garment</button>
          </div>
          <div class="mini muted">Buttons show <em>shop cost</em>. Client price uses the markup in config.</div>

          <div class="mini" style="margin-top:10px;"><em>Or enter a custom garment</em></div>
          <div class="inline-input" id="manual-cost-wrap">
            <div class="text">
              <input type="text" id="manual_garment_label" placeholder="Custom garment name (optional)" aria-label="Custom garment name">
            </div>
            <div class="money">
              <span>$</span>
              <input
                type="text"
                inputmode="decimal"
                pattern="^\\d+(?:\\.\\d{1,2})?$"
                placeholder="0.00"
                id="manual_garment_cost"
                aria-label="Custom garment cost"
              />
            </div>
            <button type="button" class="btn" id="clear_manual_cost">Clear</button>
          </div>

          <div class="mini muted">Maximum custom garment cost is $100.</div>

          <div id="manual-badge" class="badge">Preset Garment Mode</div>
          <div class="mini muted">When a custom cost is set, the quote uses your custom garment instead of a preset.</div>
        </div> </div>

      <div class="row">
        <strong>Placements</strong>
        <div class="chips" id="place-chips">
          {% set placements = (cfg.console.placements if cfg.console and cfg.console.placements else ['front','back','left_sleeve','right_sleeve']) %}
          {% for p in placements %}
            <button class="chip" data-place="{{ p }}">{{ p.replace('_',' ').title() }}</button>
          {% endfor %}
        </div>
      </div>

      <div class="row" id="colors-section" style="display:none;">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
          <strong>Colors per placement</strong>
          <span id="screens-counter">Screens: included</span>
          <button id="screens-tip" class="icon-btn" title="Loading…" aria-label="Screen charges info" type="button">ⓘ</button>
          <label id="waive-screens-wrap" class="mini" style="display:none;">
            <input type="checkbox" id="waive-screens-cb"> Waive screens (admin)
          </label>
        </div>
        <div class="grid" id="color-grid"></div>
      </div>

      {% set x = cfg.console.extras or {} %}
      <div class="row">
        <strong>Extras</strong>
        <div class="chips" id="extras-chips">
          {% set rush_mult = (x.rush_multiplier if x.rush_multiplier is not none else 0.5) %}
          <button class="chip" data-extra="rush" title="Rush: +{{ (rush_mult*100)|round(0)|int }}% after subtotal">
            Rush (+{{ (rush_mult*100)|round(0)|int }}% after subtotal)
          </button>
          {% set fb = (x.fold_bag_per_shirt if x.fold_bag_per_shirt is not none else 0) %}
          <button class="chip" data-extra="fold_bag" title="Fold &amp; Bag: +${{ '%.2f'|format(fb) }} per shirt">Fold &amp; Bag (+/shirt)</button>
          {% set nm = (x.names_per_shirt if x.names_per_shirt is not none else 0) %}
          <button class="chip" data-extra="names" title="Names: +${{ '%.2f'|format(nm) }} per shirt">Names (+/shirt)</button>
          {% set nb = (x.numbers_per_shirt if x.numbers_per_shirt is not none else 0) %}
          <button class="chip" data-extra="numbers" title="Numbers: +${{ '%.2f'|format(nb) }} per shirt">Numbers (+/shirt)</button>
          {% set hp = (x.heat_press_per_shirt if x.heat_press_per_shirt is not none else 0) %}
          <button class="chip" data-extra="heat_press" title="Heat Press: +${{ '%.2f'|format(hp) }} per shirt">Heat Press (+/shirt)</button>
          {% set tg = (x.tagging_per_shirt if x.tagging_per_shirt is not none else 0) %}
          <button class="chip" data-extra="tagging" title="Tagging (+/shirt)">Tagging (+/shirt)</button>
        </div>
      </div>

      {% set ups = cfg.console.upsell_module or {} %}
      {% if ups.enabled %}
      <div class="row" id="upsell-section">
        <strong>{{ ups.title or 'Upsell Items' }}</strong>
        <div class="chips" id="upsell-chips" role="radiogroup" aria-label="Upsell Items">
          {% for it in (ups['items'] or []) %}
            <button class="chip" type="button" data-ukey="{{ it.key }}" data-ulabel="{{ it.label }}" data-urate="{{ '%.6f'|format(it.rate_per_sqft) }}">{{ it.label }}</button>
          {% endfor %}
        </div>

        <div id="upsell-inputs" style="display:none; margin-top:12px;">
          <div class="inline-input" style="max-width:560px;">
            <div class="text" style="width:160px;">
              <input id="upsell-width" type="number" step="0.1" min="0.1" max="{{ ups.defaults.max_width_in or 300 }}" placeholder="Width (in)" aria-label="Width (in)">
            </div>
            <div class="text" style="width:160px;">
              <input id="upsell-height" type="number" step="0.1" min="0.1" max="{{ ups.defaults.max_height_in or 300 }}" placeholder="Height (in)" aria-label="Height (in)">
            </div>
            <div class="text" style="width:120px;">
              <input id="upsell-qty" type="number" step="1" min="1" max="1000" value="1" placeholder="Qty" aria-label="Quantity">
            </div>
          </div>
          <div class="mini" id="upsell-meta" style="margin-top:8px;"></div>
          <div class="badge" id="upsell-total" style="margin-top:6px;">Upsell: $0.00</div>
          <div class="mini error" id="upsellError" style="display:none; margin-top:6px;">Enter width, height, and quantity.</div>
        </div>
      </div>
      {% endif %}

      <div class="actions">
        <button class="btn" id="reset">Reset</button>
        <button class="btn primary" id="quick-quote">Quick Quote</button>

        <div class="email-controls" style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
          <input id="custEmail" type="email" placeholder="customer@email.com" value="quote@screenprintbot.com">
          <button class="btn" id="email" disabled>Email Estimate</button>
        </div>
      </div>
      <div id="emailStatus" class="mini" style="margin-top:6px;" role="status" aria-live="polite"></div>
    </main>
  </div>

  <dialog id="dtfModal">
    <div class="modal-body">
      <div class="modal-title">DTF recommended for small runs</div>
      <div class="note" style="font-size:16px;">
        Screen print minimum is <strong>48</strong>. For quantities below 48, we recommend DTF transfers.
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn primary" id="dtfOk">OK</button>
    </div>
  </dialog>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  try {
    const TENANT = "{{ tenant|default('demo') }}";
    const SC_CFG = {{ (cfg.console.screen_charges or {})|tojson }};
    const SHOW_ADMIN = {{ (cfg.console.show_admin_controls if cfg.console and cfg.console.show_admin_controls else false)|tojson }};
    const EXTRAS_CFG = {{ (cfg.console.extras or {})|tojson }};
    const UPS_CFG = {{ (cfg.console.upsell_module or {})|tojson }};
    const MAX_COLORS_DEFAULT = {{ (cfg.console.max_colors if cfg.console and cfg.console.max_colors else 6)|tojson }};
    const MAX_COLORS_PER_PLACEMENT = {{ (cfg.console.max_colors_per_placement or {})|tojson }};
    const MIN_QTY_SCREENPRINT = 48;
    const GARMENT_MARKUP = {{ (cfg.console.garment_markup_pct if cfg.console and cfg.console.garment_markup_pct is not none else 0.40)|tojson }};
    const GARMENTS = {{ (cfg.console.garments or [])|tojson }};
    {% set features = (cfg.console.features if cfg.console and cfg.console.features else {}) %}
    const ALLOW_MANUAL_COST = {{ (features.allow_manual_cost if features and features.allow_manual_cost is defined else true)|tojson }};

    /* ============== DOM REFS ============== */
    const qtyChips       = document.getElementById('qty-chips');
    const placeChips     = document.getElementById('place-chips');
    const colorSection   = document.getElementById('colors-section');
    const colorGrid      = document.getElementById('color-grid');
    const extrasChips    = document.getElementById('extras-chips');
    const garmentChips   = document.getElementById('garment-chips');
    const customChip     = document.getElementById('custom-garment-chip');
    const manualLabelEl  = document.getElementById('manual_garment_label');
    const manualCostEl   = document.getElementById('manual_garment_cost');
    const clearManualBtn = document.getElementById('clear_manual_cost');
    const manualBadge    = document.getElementById('manual-badge');
    const liveTotal      = document.getElementById('live-total');
    const liveGarment    = document.getElementById('live-garment');
    const liveBreakdown  = document.getElementById('live-breakdown');
    const qbBtn          = document.getElementById('quick-quote');
    const resetBtn       = document.getElementById('reset');
    const emailBtn       = document.getElementById('email');
    const emailInput     = document.getElementById('custEmail');
    const emailStatus    = document.getElementById('emailStatus');
    const screensCounter = document.getElementById('screens-counter');
    const screensTip     = document.getElementById('screens-tip');
    const waiveWrap      = document.getElementById('waive-screens-wrap');
    const waiveCb        = document.getElementById('waive-screens-cb');
    const dtfModal       = document.getElementById('dtfModal');
    const dtfOkBtn       = document.getElementById('dtfOk');
    const upsellChips    = document.getElementById('upsell-chips');
    const upsellInputs   = document.getElementById('upsell-inputs');
    const upsellWidthEl  = document.getElementById('upsell-width');
    const upsellHeightEl = document.getElementById('upsell-height');
    const upsellQtyEl    = document.getElementById('upsell-qty');
    const upsellMeta     = document.getElementById('upsell-meta');
    const upsellTotalEl  = document.getElementById('upsell-total');
    const upsellError    = document.getElementById('upsellError');
    const garmentSectionWrapper = document.getElementById('garment-section-wrapper');
    const customerSuppliedToggle = document.getElementById('customer-supplied-toggle');
    const qtyOther       = document.getElementById('qty-other');

    /* ============== STATE ============== */
    const S = { qty: null, garmentKey: null, garmentCost: null, garmentLabel: null, manualCost: null, manualLabel: '', places: new Set(), colors: {}, extras: new Set(), upsell: null };

    /* ============== HELPERS ============== */
    const fmt = n => n == null ? '—' : Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const maxColorsFor = place => MAX_COLORS_PER_PLACEMENT[place] ?? MAX_COLORS_DEFAULT;
    const screensIncludedInPrice = () => !SC_CFG.enabled;
    function computeScreens() {
      if (!SC_CFG.enabled) return { count: 0, total: 0 };
      let cnt = 0;
      for (const p of S.places) cnt += (S.colors[p] || 0);
      if (SC_CFG.count_white_underbase) cnt += S.places.size;
      const pps = parseFloat(SC_CFG.price_per_screen) || 0;
      const waived = waiveCb && waiveCb.checked;
      const total = waived ? 0 : cnt * pps;
      return { count: cnt, total };
    }
    function screenprintReady() { return S.places.size > 0 || !!S.garmentKey || !!S.manualCost; }
    function showDTFModal() { dtfModal.showModal(); }
    dtfOkBtn.addEventListener('click', () => dtfModal.close());

    /* ============== GARMENTS ============== */
    garmentChips.querySelectorAll('[data-gkey]').forEach(btn => {
      btn.addEventListener('click', () => {
        garmentChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.gkey;
        const g = GARMENTS.find(x => x.key === key);
        S.garmentKey = key;
        S.garmentCost = g ? g.cost : null;
        S.garmentLabel = g ? g.label : key;
        clearManual(false);
        render();
      });
    });
    customChip?.addEventListener('click', () => {
      garmentChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      customChip.classList.add('active');
      S.garmentKey = null; S.garmentCost = null; S.garmentLabel = null;
      manualLabelEl.focus();
      render();
    });

    /* ============== MANUAL COST ============== */
    function applyManualCost() {
      const raw = manualCostEl.value.replace(/[^0-9.]/g, '');
      const v = parseFloat(raw);
      if (!isNaN(v) && v > 0 && v <= 100) {
        S.manualCost = v;
        S.manualLabel = manualLabelEl.value.trim() || 'Custom';
        S.garmentKey = null; S.garmentCost = null; S.garmentLabel = null;
        garmentChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        customChip?.classList.add('active');
      } else {
        S.manualCost = null;
        S.manualLabel = '';
      }
      render();
    }
    function clearManual(alsoRender = true) {
      manualCostEl.value = '';
      manualLabelEl.value = '';
      S.manualCost = null;
      S.manualLabel = '';
      if (alsoRender) render();
    }
    manualCostEl.addEventListener('input', applyManualCost);
    manualLabelEl.addEventListener('input', () => { if (S.manualCost) { S.manualLabel = manualLabelEl.value.trim() || 'Custom'; render(); } });
    clearManualBtn.addEventListener('click', () => clearManual(true));

    /* ============== CUSTOMER-SUPPLIED TOGGLE ============== */
    customerSuppliedToggle.addEventListener('change', () => {
      const isSupplied = customerSuppliedToggle.checked;
      garmentSectionWrapper.style.display = isSupplied ? 'none' : '';
      if (isSupplied) {
        S.garmentKey = null; S.garmentCost = null; S.garmentLabel = null;
        clearManual(false);
        garmentChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      }
      render();
    });

    /* ============== QTY ============== */
    qtyChips.querySelectorAll('[data-qty]').forEach(btn => {
      btn.addEventListener('click', () => {
        qtyChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        S.qty = parseInt(btn.dataset.qty, 10);
        render();
      });
    });
    qtyOther?.addEventListener('click', () => {
      const v = prompt('Enter quantity:', '');
      if (v === null) return;
      const n = parseInt(v, 10);
      if (isNaN(n) || n < 1) { alert('Invalid quantity'); return; }
      qtyChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      qtyOther.classList.add('active');
      qtyOther.textContent = n;
      S.qty = n;
      render();
    });

    /* ============== PLACEMENTS ============== */
    placeChips.querySelectorAll('[data-place]').forEach(btn => {
      btn.addEventListener('click', () => {
        const p = btn.dataset.place;
        btn.classList.toggle('active');
        if (S.places.has(p)) { S.places.delete(p); delete S.colors[p]; }
        else { S.places.add(p); S.colors[p] = 1; }
        buildColorGrid();
        render();
      });
    });

    /* ============== COLOR GRID ============== */
    function buildColorGrid() {
      colorGrid.innerHTML = '';
      if (!S.places.size) { colorSection.style.display = 'none'; return; }
      colorSection.style.display = '';
      for (const p of S.places) {
        const max = maxColorsFor(p);
        const card = document.createElement('div'); card.className = 'card';
        const title = document.createElement('div'); title.className = 'card-title';
        title.textContent = p.replace(/_/g, ' ').toUpperCase();
        card.appendChild(title);
        const cols = document.createElement('div');
        cols.className = max > 5 ? 'color-columns two' : 'color-columns one';
        for (let i = 1; i <= max; i++) {
          const cb = document.createElement('button');
          cb.type = 'button'; cb.className = 'chip' + (S.colors[p] === i ? ' active' : '');
          cb.textContent = i + ' color' + (i > 1 ? 's' : '');
          cb.addEventListener('click', () => {
            S.colors[p] = i;
            card.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
            cb.classList.add('active');
            render();
          });
          cols.appendChild(cb);
        }
        card.appendChild(cols);
        colorGrid.appendChild(card);
      }
    }

    /* ============== EXTRAS ============== */
    extrasChips.querySelectorAll('[data-extra]').forEach(btn => {
      btn.addEventListener('click', () => {
        const e = btn.dataset.extra;
        btn.classList.toggle('active');
        S.extras.has(e) ? S.extras.delete(e) : S.extras.add(e);
        render();
      });
    });

    /* ============== UPSELL ============== */
    if (upsellChips) {
      upsellChips.querySelectorAll('[data-ukey]').forEach(btn => {
        btn.addEventListener('click', () => {
          const wasActive = btn.classList.contains('active');
          upsellChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          if (wasActive) {
            S.upsell = null;
            upsellInputs.style.display = 'none';
          } else {
            btn.classList.add('active');
            S.upsell = { key: btn.dataset.ukey, label: btn.dataset.ulabel, rate: parseFloat(btn.dataset.urate) };
            upsellInputs.style.display = '';
          }
          render();
        });
      });
      [upsellWidthEl, upsellHeightEl, upsellQtyEl].forEach(el => el?.addEventListener('input', render));
    }

    /* ============== WAIVE SCREENS ============== */
    if (SHOW_ADMIN && SC_CFG.enabled) waiveWrap.style.display = '';
    waiveCb?.addEventListener('change', render);

    /* ============== SCREENS TIP ============== */
    function updateScreensTip() {
      if (!SC_CFG.enabled) { screensTip.title = 'Screen charges are disabled (included in ink pricing).'; return; }
      const { count, total } = computeScreens();
      const pps = parseFloat(SC_CFG.price_per_screen) || 0;
      let tip = `Screens: ${count} × $${fmt(pps)} = $${fmt(total)}`;
      if (waiveCb?.checked) tip += ' (waived)';
      screensTip.title = tip;
    }

    /* ============== RENDER ============== */
    function render() {
      const isSupplied = customerSuppliedToggle.checked;
      const usingManual = S.manualCost !== null;
      const costForCalc = isSupplied ? 0 : (usingManual ? S.manualCost : (S.garmentCost || 0));
      const labelForCalc = isSupplied ? '(Customer-supplied)' : (usingManual ? S.manualLabel : (S.garmentLabel || ''));
      const clientPrice = isSupplied ? 0 : costForCalc * (1 + GARMENT_MARKUP);

      manualBadge.textContent = usingManual ? 'Custom Garment Mode' : 'Preset Garment Mode';
      manualBadge.classList.toggle('active', usingManual);

      if (labelForCalc && S.qty) {
        liveGarment.innerHTML = `${labelForCalc} — customer <strong>$${fmt(clientPrice)}</strong> — markup ${(GARMENT_MARKUP * 100).toFixed(0)}%`;
      } else if (!labelForCalc && !isSupplied) {
        liveGarment.textContent = 'Select a garment to begin';
      } else if (isSupplied) {
        liveGarment.textContent = 'Customer-supplied garments — printing only';
      }

      const { count: screenCount, total: screensTotal } = computeScreens();
      const screensIncluded = screensIncludedInPrice();
      screensCounter.textContent = screensIncluded ? 'Screens: included' : `Screens: ${screenCount}`;
      screensCounter.classList.toggle('active', !screensIncluded && screenCount > 0);
      updateScreensTip();

      let upsellTotal = 0;
      if (S.upsell) {
        const w = parseFloat(upsellWidthEl?.value) || 0;
        const h = parseFloat(upsellHeightEl?.value) || 0;
        const uq = parseInt(upsellQtyEl?.value, 10) || 1;
        if (w > 0 && h > 0) {
          const sqft = (w * h) / 144;
          upsellTotal = sqft * S.upsell.rate * uq;
          upsellMeta.textContent = `${w}" × ${h}" = ${sqft.toFixed(3)} sq ft × $${S.upsell.rate.toFixed(4)}/sq ft × ${uq} = $${fmt(upsellTotal)}`;
          upsellTotalEl.textContent = `Upsell: $${fmt(upsellTotal)}`;
          upsellError.style.display = 'none';
        } else {
          upsellMeta.textContent = '';
          upsellTotalEl.textContent = 'Upsell: $0.00';
          upsellError.style.display = '';
        }
      }

      if (!S.qty) { liveTotal.textContent = '$0.00'; liveBreakdown.textContent = 'Waiting for inputs…'; return; }

      const garmentsTotal = S.qty * clientPrice;
      let inkTotal = 0;
      const inkLines = [];
      for (const p of S.places) {
        const c = S.colors[p] || 0;
        const rate = 0.50 + (c - 1) * 0.25;
        const loc = S.qty * rate;
        inkTotal += loc;
        inkLines.push(`<div class="line"><span>${p.replace(/_/g, ' ').replace(/\b\w/g, m => m.toUpperCase())} — ${c} color${c > 1 ? 's' : ''} (${S.qty} × $${fmt(rate)})</span><span>$${fmt(loc)}</span></div>`);
      }

      let extrasTotal = 0;
      const extraLines = [];
      if (S.extras.has('fold_bag')) { const v = (EXTRAS_CFG.fold_bag_per_shirt || 0) * S.qty; extrasTotal += v; extraLines.push(`<div class="line"><span>Fold Bag</span><span>$${fmt(v)}</span></div>`); }
      if (S.extras.has('names')) { const v = (EXTRAS_CFG.names_per_shirt || 0) * S.qty; extrasTotal += v; extraLines.push(`<div class="line"><span>Names</span><span>$${fmt(v)}</span></div>`); }
      if (S.extras.has('numbers')) { const v = (EXTRAS_CFG.numbers_per_shirt || 0) * S.qty; extrasTotal += v; extraLines.push(`<div class="line"><span>Numbers</span><span>$${fmt(v)}</span></div>`); }
      if (S.extras.has('heat_press')) { const v = (EXTRAS_CFG.heat_press_per_shirt || 0) * S.qty; extrasTotal += v; extraLines.push(`<div class="line"><span>Heat Press</span><span>$${fmt(v)}</span></div>`); }
      if (S.extras.has('tagging')) { const v = (EXTRAS_CFG.tagging_per_shirt || 0) * S.qty; extrasTotal += v; extraLines.push(`<div class="line"><span>Tagging</span><span>$${fmt(v)}</span></div>`); }

      const subtotal = garmentsTotal + inkTotal + screensTotal + extrasTotal + upsellTotal;
      let rushAmt = 0;
      if (S.extras.has('rush')) { rushAmt = subtotal * (EXTRAS_CFG.rush_multiplier || 0.5); }
      const grand = subtotal + rushAmt;

      liveTotal.textContent = '$' + fmt(grand);
      let bdHtml = '';
      if (!isSupplied) bdHtml += `<h3>Garment</h3><div class="line"><span>${labelForCalc} (${S.qty} × $${fmt(clientPrice)})</span><span>$${fmt(garmentsTotal)}</span></div>`;
      bdHtml += `<h3>Ink/Print</h3>${inkLines.join('') || '<div class="line muted">No placements selected</div>'}`;
      if (!screensIncluded) bdHtml += `<div class="line"><span>Screens</span><span>${screensTotal > 0 ? '$' + fmt(screensTotal) : 'Included'}</span></div>`;
      else bdHtml += `<div class="line"><span>Screens</span><span>Included</span></div>`;
      if (extraLines.length) bdHtml += `<h3>Extras</h3>${extraLines.join('')}`;
      if (upsellTotal > 0) bdHtml += `<h3>Upsell</h3><div class="line"><span>${S.upsell.label}</span><span>$${fmt(upsellTotal)}</span></div>`;
      bdHtml += `<h3>Summary</h3>`;
      bdHtml += `<div class="line"><span>Subtotal</span><span>$${fmt(subtotal)}</span></div>`;
      if (rushAmt > 0) bdHtml += `<div class="line rush"><span>Rush (+${((EXTRAS_CFG.rush_multiplier || 0.5) * 100).toFixed(0)}%)</span><span>$${fmt(rushAmt)}</span></div>`;
      bdHtml += `<div class="sep"></div><div class="line"><strong>Total</strong><strong>$${fmt(grand)}</strong></div>`;
      bdHtml += `<div class="line muted"><span>Price per shirt</span><span>$${fmt(grand / S.qty)}</span></div>`;
      liveBreakdown.innerHTML = bdHtml;
    }

    /* ============== RESET ============== */
    resetBtn.addEventListener('click', () => {
      S.qty = null; S.garmentKey = null; S.garmentCost = null; S.garmentLabel = null; S.manualCost = null; S.manualLabel = '';
      S.places.clear(); S.colors = {}; S.extras.clear(); S.upsell = null;
      document.querySelectorAll('.chip.active').forEach(c => c.classList.remove('active'));
      colorGrid.innerHTML = ''; colorSection.style.display = 'none';
      if (upsellInputs) upsellInputs.style.display = 'none';
      if (upsellWidthEl) upsellWidthEl.value = '';
      if (upsellHeightEl) upsellHeightEl.value = '';
      if (upsellQtyEl) upsellQtyEl.value = '1';
      customerSuppliedToggle.checked = false;
      garmentSectionWrapper.style.display = '';
      clearManual(false);
      qtyOther.textContent = 'Other…';
      waiveCb && (waiveCb.checked = false);
      emailStatus.textContent = '';
      window.__lastQuote = null;
      render();
    });

    /* ============== QUICK QUOTE ============== */
    qbBtn.addEventListener('click', async () => {
      if (S.qty && S.qty < MIN_QTY_SCREENPRINT && screenprintReady()) { showDTFModal(); return; }
      if (!S.qty) { alert('Select a quantity.'); return; }
      const isSupplied = customerSuppliedToggle.checked;
      if (!isSupplied && !S.garmentKey && S.manualCost === null) { alert('Select or enter a garment.'); return; }
      if (!S.places.size) { alert('Select at least one placement.'); return; }

      const usingManual = S.manualCost !== null;
      const payload = {
        quantity: S.qty,
        garment_key: isSupplied ? null : (usingManual ? '__custom__' : S.garmentKey),
        garment_cost: isSupplied ? 0 : (usingManual ? S.manualCost : S.garmentCost),
        garment_label: isSupplied ? '(Customer-supplied)' : (usingManual ? S.manualLabel : S.garmentLabel),
        locations: [...S.places].map(p => ({ location: p, colors: S.colors[p] || 1 })),
        extras: [...S.extras],
        waive_screens: waiveCb?.checked || false,
      };
      if (S.upsell) {
        payload.upsell = {
          key: S.upsell.key,
          label: S.upsell.label,
          rate_per_sqft: S.upsell.rate,
          width_in: parseFloat(upsellWidthEl?.value) || 0,
          height_in: parseFloat(upsellHeightEl?.value) || 0,
          qty: parseInt(upsellQtyEl?.value, 10) || 1,
        };
      }
      qbBtn.disabled = true; qbBtn.textContent = 'Calculating…';
      try {
        const res = await fetch(`/api/console/quote/${TENANT}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Quote failed');
        window.__lastQuote = data.quote;
        render();
        updateEmailButtonState();
      } catch (e) { alert(e.message); }
      finally { qbBtn.disabled = false; qbBtn.textContent = 'Quick Quote'; }
    });

    /* ============== EMAIL ============== */
    function isValidEmail(e) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function updateEmailButtonState() { emailBtn.disabled = !window.__lastQuote || !isValidEmail(emailInput.value.trim()); }

    function renderEstimateHTML(q) {
      if (!q) return '<p>No quote data.</p>';
      const esc = s => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const toNum = v => (v == null || v === '') ? null : Number(v);
      const qty = toNum(q.quantity) ?? 0;
      const garmentLabel = q.garment_label || q.garment_key || '';
      const garmentUnitClient = toNum(q.garment_client_price);
      const garmentsTotal = toNum(q.garments_total);
      const inkTotal = toNum(q.ink_total) ?? 0;
      const screensTotal = toNum(q.screens_total) ?? 0;
      const rushFee = toNum(q.rush_fee) ?? 0;
      const rushPct = toNum(q.rush_pct) ?? 0;
      const grand = toNum(q.total);
      const tax = toNum(q.tax) ?? 0;
      const itemsSubtotal = toNum(q.items_subtotal) ?? (grand - rushFee);
      const upsellTotal = toNum(q.upsell_total) ?? 0;
      const screensIncluded = q.screens_included ?? screensIncludedInPrice();
      const locs = Array.isArray(q?.locations) ? q.locations : [];
      const placements = locs.map(loc => `${(loc.location || '').replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase())} — ${loc.colors || 0} color${(loc.colors||0)>1?'s':''}`);
      const shirtsSubtotal = Math.max(0, +((grand || 0) - (upsellTotal || 0)).toFixed(2));
      const perShirt = qty > 0 ? shirtsSubtotal / qty : null;
      const rows = [];
      rows.push(`<h1 style="margin:0 0 8px;font-family:system-ui,Segoe UI,Arial;">Estimate</h1>`);
      rows.push(`<p style="margin:0 0 16px;font-size:14px;color:#444">Thanks for the opportunity! Here's your estimate.</p>`);
      rows.push(`<table style="border-collapse:collapse;width:100%;max-width:600px;font:14px/1.4 system-ui,Segoe UI,Arial">`);
      rows.push(`<tr><td style="padding:8px 0;font-weight:600">Total</td><td style="padding:8px 0;text-align:right">$${fmt(grand)}</td></tr>`);
      rows.push(`<tr><td style="padding:6px 0">Printed shirts</td><td style="padding:6px 0;text-align:right">$${fmt(shirtsSubtotal)}</td></tr>`);
      if (perShirt != null) rows.push(`<tr><td style="padding:6px 0;color:#555">Price per shirt</td><td style="padding:6px 0;text-align:right;color:#555">$${fmt(perShirt)}</td></tr>`);
      if (garmentLabel || garmentsTotal != null) {
        rows.push(`<tr><td colspan="2" style="padding:10px 0 4px;font-weight:700;background:#f2f2f2;border-radius:4px">Garment</td></tr>`);
        const garmentRight = garmentsTotal != null ? `$${fmt(garmentsTotal)}` : (garmentUnitClient != null ? `$${fmt(garmentUnitClient)}` : '');
        const garmentLeft = garmentUnitClient != null && qty ? `${esc(garmentLabel || 'Garment')} (${qty} × $${fmt(garmentUnitClient)})` : esc(garmentLabel || 'Garment');
        rows.push(`<tr><td style="padding:6px 0">${garmentLeft}</td><td style="padding:6px 0;text-align:right">${garmentRight}</td></tr>`);
      }
      rows.push(`<tr><td colspan="2" style="padding:10px 0 4px;font-weight:700;background:#f2f2f2;border-radius:4px">Ink/Print</td></tr>`);
      if (locs.length) {
        locs.forEach(loc => {
          const unit = toNum(loc.per_shirt_run) ?? 0;
          const locTotal = +(unit * (qty || 0)).toFixed(2);
          const title = String(loc.location || '').replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
          const colors = toNum(loc.colors) ?? 0;
          rows.push(`<tr><td style="padding:6px 0">${title} — ${colors} color${colors>1?'s':''} (${qty} × $${fmt(unit)})</td><td style="padding:6px 0;text-align:right">$${fmt(locTotal)}</td></tr>`);
        });
      }
      if (!screensIncluded) rows.push(`<tr><td style="padding:6px 0">Screens</td><td style="padding:6px 0;text-align:right">$${fmt(screensTotal)}</td></tr>`);
      else rows.push(`<tr><td style="padding:6px 0">Screens</td><td style="padding:6px 0;text-align:right;color:#777">Included</td></tr>`);
      const extras = q?.extras || {};
      const extraEntries = Object.entries(extras).filter(([k,v]) => /_total$/i.test(k) && toNum(v) > 0 && !/^rush_total$/i.test(k));
      if (extraEntries.length) {
        rows.push(`<tr><td colspan="2" style="padding:10px 0 4px;font-weight:700;background:#f2f2f2;border-radius:4px">Extras</td></tr>`);
        extraEntries.forEach(([k,v]) => {
          const nice = k.replace(/_total$/,'').replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
          rows.push(`<tr><td style="padding:6px 0">${esc(nice)}</td><td style="padding:6px 0;text-align:right">$${fmt(toNum(v))}</td></tr>`);
        });
      }
      if (upsellTotal > 0) {
        const u = q.upsell || {};
        const dims = (u.width_in && u.height_in) ? `${(+u.width_in).toFixed(1)}" × ${(+u.height_in).toFixed(1)}", Qty ${u.qty || 1}` : '';
        rows.push(`<tr><td colspan="2" style="padding:10px 0 4px;font-weight:700;background:#f2f2f2;border-radius:4px">Upsell Items</td></tr>`);
        rows.push(`<tr><td style="padding:6px 0">${esc(u.label || u.key || 'Item')}${dims ? `<div style="font-size:12px;color:#777;">${dims}</div>` : ''}</td><td style="padding:6px 0;text-align:right">$${fmt(upsellTotal)}</td></tr>`);
      }
      rows.push(`<tr><td colspan="2" style="padding:10px 0 4px;font-weight:700;background:#f2f2f2;border-radius:4px">Summary</td></tr>`);
      const hasRush = rushFee > 0;
      rows.push(`<tr><td style="padding:6px 0">${hasRush ? 'Items subtotal' : 'Subtotal'}</td><td style="padding:6px 0;text-align:right">$${fmt(itemsSubtotal)}</td></tr>`);
      if (hasRush) {
        const pctTxt = (rushPct > 0) ? ` (${(rushPct * 100).toFixed(0)}% of $${fmt(itemsSubtotal)})` : '';
        rows.push(`<tr><td style="padding:6px 0;color:#b91c1c;font-weight:600">Rush${pctTxt}</td><td style="padding:6px 0;text-align:right;color:#b91c1c;font-weight:600">$${fmt(rushFee)}</td></tr>`);
        const withRush = +(itemsSubtotal + rushFee).toFixed(2);
        rows.push(`<tr><td style="padding:6px 0">Subtotal (before tax)</td><td style="padding:6px 0;text-align:right">$${fmt(withRush)}</td></tr>`);
      }
      if (tax > 0) rows.push(`<tr><td style="padding:6px 0">Tax</td><td style="padding:6px 0;text-align:right">$${fmt(tax)}</td></tr>`);
      if (qty) rows.push(`<tr><td style="padding:10px 0 0;color:#555">Quantity</td><td style="padding:10px 0 0;text-align:right;color:#555">${qty}</td></tr>`);
      if (garmentLabel) rows.push(`<tr><td style="padding:6px 0;color:#555">Garment</td><td style="padding:6px 0;text-align:right;color:#555">${esc(garmentLabel)}</td></tr>`);
      if (placements.length) rows.push(`<tr><td style="padding:6px 0;color:#555">Placements</td><td style="padding:6px 0;text-align:right;color:#555">${placements.join(', ')}</td></tr>`);
      rows.push(`</table>`);
      rows.push(`<p style="margin-top:16px;font-size:12px;color:#777">Reply to this email with any changes and we'll update the quote.</p>`);
      return rows.join("");
    }

    function renderTextFallback(html) {
      return html.replace(/<style[\s\S]*?<\/style>/gi, "").replace(/<[^>]+>/g, " ").replace(/\s{2,}/g, " ").trim();
    }

    async function sendEstimate({ to, subject, html }) {
      const res = await fetch("/api/email-estimate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customer_email: to, subject, html_body: html, text_body: renderTextFallback(html) }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.Message || data.error || `HTTP ${res.status}`);
      return data;
    }

    emailBtn.addEventListener('click', async () => {
      if (S.qty && S.qty < MIN_QTY_SCREENPRINT && screenprintReady()) { showDTFModal(); return; }
      if (!window.__lastQuote) { emailStatus.textContent = 'Complete the steps to generate a quote before emailing.'; return; }
      const to = (emailInput.value || '').trim();
      if (!isValidEmail(to)) { emailStatus.textContent = 'Enter a valid email.'; return; }
      const html = renderEstimateHTML(window.__lastQuote);
      const subject = `Your Estimate from {{ cfg.brand_name }}`;
      emailBtn.disabled = true; const old = emailBtn.textContent; emailBtn.textContent = 'Sending…';
      emailStatus.textContent = '';
      try {
        const result = await sendEstimate({ to, subject, html });
        console.log('Email sent MessageID:', result.MessageID || result.messageId || '(unknown)');
        emailStatus.textContent = `Estimate sent to ${to}.`;
      } catch (e) {
        emailStatus.textContent = `Send failed: ${e.message}`;
      } finally {
        emailBtn.disabled = false; emailBtn.textContent = old;
      }
    });

    emailInput.addEventListener('input', updateEmailButtonState);

  } catch (err) {
    console.error('Console init failed:', err);
    const liveBreak = document.getElementById('live-breakdown');
    if (liveBreak) liveBreak.textContent = 'Error initializing console. Check console for details.';
  }

  updateEmailButtonState();
  });
  </script>
</body>
</html>
